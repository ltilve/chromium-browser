<!DOCTYPE html>
<!--
Copyright (c) 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/base/statistics.html">
<link rel="import" href="/tracing/base/units/units.html">
<link rel="import" href="/tracing/base/units/histogram.html">
<link rel="import" href="/tracing/ui/base/table.html">
<link rel="import" href="/tracing/ui/units/scalar_span.html">

<polymer-element name="tr-ui-u-histogram-span">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
      }

      #stats {
        display: flex;
        flex-direction: row;
        flex: 0 0 auto;
        font-weight: bold;
      }

      #nnans {
        color: red;
      }
      #table {
        flex: 1 1 auto;
      }
    </style>
    <div id="stats">
      <span id="nsamples"></span>&nbsp;samples,&nbsp;
      <span id="hadnans"><span id="nnans"></span> non-numeric samples,&nbsp;
      </span>
      average=<tr-ui-u-scalar-span id="average"></tr-ui-u-scalar-span>
    </div>
    <tr-ui-b-table id="table">
    </tr-ui-b-table>
  </template>
  <script>
  'use strict';

  Polymer({
    created: function() {
      this.histogram_ = undefined;
    },

    get histogram() {
      return this.histogram_;
    },

    set histogram(histogram) {
      this.histogram_ = histogram;
      this.updateContents_();
    },

    updateContents_: function() {
      var table = this.$.table;
      if (!this.histogram_) {
        this.$.nsamples.textContent = 0;
        this.$.average.setValueAndUnit(undefined, undefined);
        this.$.table.tableRows = [];
        return;
      }

      this.$.nsamples.textContent = this.histogram_.numValues;
      this.$.average.setValueAndUnit(this.histogram_.average,
                                     this.histogram_.unit);
      if (this.histogram_.numNans > 0) {
        this.$.hadnans.style.display = '';
        this.$.nnans.textContent = this.histogram_.numNans;
      } else {
        this.$.hadnans.style.display = 'none';
      }

      var maximumBinValue = tr.b.Statistics.max(this.histogram_.allBins,
                                                function(bin) {
                                                  return bin.count;
                                                });
      table.tableColumns = [
        {
          title: 'Min',
          width: '200px',
          value: function(bin) {
            if (bin === this.histogram_.underflowBin)
              return '-' + String.fromCharCode(0x221e);
            var span = document.createElement('tr-ui-u-scalar-span');
            span.setValueAndUnit(bin.range.min, this.histogram_.unit);
            return span;
          }.bind(this)
        },
        {
          title: 'Max (exclusive)',
          width: '200px',
          value: function(bin) {
            if (bin === this.histogram_.overflowBin)
              return String.fromCharCode(0x221e);
            var span = document.createElement('tr-ui-u-scalar-span');
            span.setValueAndUnit(bin.range.max, this.histogram_.unit);
            return span;
          }.bind(this)
        },
        {
          title: 'Quantity',
          width: '100%',
          value: function(bin) {
            var span = document.createElement('tr-ui-u-scalar-span');
            span.setValueAndUnit(bin.count, tr.b.u.Units.unitlessNumber);
            span.percentage = bin.count / maximumBinValue;
            span.rightAlign = true;
            return span;
          }
        }
      ];
      var rows = [];
      if (this.histogram_.underflowBin.count)
        rows.push(this.histogram_.underflowBin);
      rows.push.apply(rows, this.histogram.centralBins);
      if (this.histogram_.overflowBin.count)
        rows.push(this.histogram_.overflowBin);
      table.tableRows = rows;
      this.rowHighlightEnabled = true;
      table.rebuild();
    }
  });
  </script>
</polymer-element>
